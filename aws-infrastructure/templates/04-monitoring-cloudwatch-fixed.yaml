echo "ğŸ”§ IAMæ¨©é™ã®ä¿®æ­£ã¨ã‚¹ã‚¿ãƒƒã‚¯å†ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †"
echo "============================================="

# 1. ç¾åœ¨ã®IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ç¢ºèª
echo "ğŸ“‹ ç¾åœ¨ã®IAMãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’ç¢ºèª:"
aws iam list-attached-user-policies --user-name portfolio-deploy-IAM
echo ""
aws iam list-user-policies --user-name portfolio-deploy-IAM

echo ""
echo "============================================="

# 2. å¿…è¦ãªæ¨©é™ã‚’è¿½åŠ ã™ã‚‹IAMãƒãƒªã‚·ãƒ¼ä½œæˆ
echo "ğŸ”‘ å¿…è¦ãªæ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ãŸã‚ã®è¿½åŠ ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ:"

cat << 'EOF' > monitoring-iam-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "sns:*",
                "ssm:PutParameter",
                "ssm:GetParameter",
                "ssm:DeleteParameter",
                "ssm:GetParameters",
                "ssm:DescribeParameters",
                "cloudwatch:*",
                "logs:*"
            ],
            "Resource": "*"
        }
    ]
}
EOF

echo "âœ… monitoring-iam-policy.json ã‚’ä½œæˆã—ã¾ã—ãŸ"
echo ""

# 3. IAMãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ
echo "ğŸ”— IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿½åŠ æ¨©é™ã‚’ã‚¢ã‚¿ãƒƒãƒ:"
echo ""
echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
echo ""
echo "# æ–°ã—ã„ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ"
echo "aws iam create-policy \\"
echo "  --policy-name PortfolioMonitoringPolicy \\"
echo "  --policy-document file://monitoring-iam-policy.json"
echo ""
echo "# ãƒãƒªã‚·ãƒ¼ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ã‚¿ãƒƒãƒ"
echo "aws iam attach-user-policy \\"
echo "  --user-name portfolio-deploy-IAM \\"
echo "  --policy-arn arn:aws:iam::276983626342:policy/PortfolioMonitoringPolicy"

echo ""
echo "============================================="

# 4. å¤±æ•—ã—ãŸã‚¹ã‚¿ãƒƒã‚¯ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
echo "ğŸ§¹ å¤±æ•—ã—ãŸã‚¹ã‚¿ãƒƒã‚¯ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—:"
echo ""
echo "aws cloudformation delete-stack \\"
echo "  --region ap-northeast-1 \\"
echo "  --stack-name \"\${PROJECT_NAME}-\${ENVIRONMENT}-monitoring\""
echo ""
echo "# å‰Šé™¤å®Œäº†ã‚’å¾…æ©Ÿ"
echo "aws cloudformation wait stack-delete-complete \\"
echo "  --region ap-northeast-1 \\"
echo "  --stack-name \"\${PROJECT_NAME}-\${ENVIRONMENT}-monitoring\""

echo ""
echo "============================================="

# 5. ä¿®æ­£ã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆï¼ˆç°¡ç•¥ç‰ˆï¼‰
echo "ğŸ“ ä¿®æ­£ã•ã‚ŒãŸCloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ:"

cat << 'EOF' > 04-monitoring-cloudwatch-fixed.yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudWatch Monitoring - Fixed IAM Issues'

Parameters:
  ProjectName:
    Type: String
    Default: 'portfolio'
    Description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå'

  Environment:
    Type: String
    Default: 'prod'
    AllowedValues: ['dev', 'staging', 'prod']
    Description: 'ç’°å¢ƒå'

  AlertEmail:
    Type: String
    Description: 'ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ã‚’å—ä¿¡ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹'
    AllowedPattern: '^[^\s@]+@[^\s@]+\.[^\s@]+$'

Resources:
  # SNS Topicï¼ˆKMSæš—å·åŒ–ãªã— - ç°¡ç•¥åŒ–ï¼‰
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${ProjectName}-${Environment}-alerts'
      DisplayName: !Sub '${ProjectName} ${Environment} Infrastructure Alerts'

  # ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã®è³¼èª­è¨­å®š
  EmailSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn: !Ref AlertTopic
      Protocol: email
      Endpoint: !Ref AlertEmail

  # CloudWatch Agentè¨­å®šï¼ˆç°¡ç•¥åŒ–ï¼‰
  CloudWatchAgentConfig:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub '/cloudwatch-agent/${ProjectName}-${Environment}/config'
      Type: String
      Value: !Sub |
        {
          "agent": {
            "metrics_collection_interval": 60,
            "run_as_user": "cwagent"
          },
          "metrics": {
            "namespace": "CWAgent",
            "metrics_collected": {
              "cpu": {
                "measurement": ["cpu_usage_user", "cpu_usage_system"],
                "metrics_collection_interval": 60
              },
              "disk": {
                "measurement": ["used_percent"],
                "metrics_collection_interval": 60,
                "resources": ["*"]
              },
              "mem": {
                "measurement": ["mem_used_percent"],
                "metrics_collection_interval": 60
              }
            }
          }
        }
      Description: 'CloudWatch Agentè¨­å®š'

  # åŸºæœ¬çš„ãªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆä¾å­˜é–¢ä¿‚ãªã—ï¼‰
  BasicDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub '${ProjectName}-${Environment}-basic-monitoring'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "text",
              "x": 0,
              "y": 0,
              "width": 24,
              "height": 3,
              "properties": {
                "markdown": "# ${ProjectName} ${Environment} ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰\n\nç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸã€‚EC2ã¨RDSã®è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯å¾Œã§è¿½åŠ ã§ãã¾ã™ã€‚"
              }
            }
          ]
        }

Outputs:
  AlertTopicArn:
    Description: 'ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ç”¨SNSãƒˆãƒ”ãƒƒã‚¯ARN'
    Value: !Ref AlertTopic
    Export:
      Name: !Sub '${AWS::StackName}-AlertTopicArn'

  DashboardURL:
    Description: 'CloudWatchç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰URL'
    Value: !Sub 'https://${AWS::Region}.console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${ProjectName}-${Environment}-basic-monitoring'

  CloudWatchAgentConfigParameter:
    Description: 'CloudWatch Agentè¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å'
    Value: !Ref CloudWatchAgentConfig
    Export:
      Name: !Sub '${AWS::StackName}-CloudWatchAgentConfig'
EOF

echo "âœ… 04-monitoring-cloudwatch-fixed.yaml ã‚’ä½œæˆã—ã¾ã—ãŸ"

echo ""
echo "============================================="

# 6. å†ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †
echo "ğŸš€ å†ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †:"
echo ""
echo "1. IAMæ¨©é™ã‚’ä¿®æ­£å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å†ãƒ‡ãƒ—ãƒ­ã‚¤:"
echo ""
echo "aws cloudformation create-stack \\"
echo "  --stack-name \"\${PROJECT_NAME}-\${ENVIRONMENT}-monitoring\" \\"
echo "  --template-body file://04-monitoring-cloudwatch-fixed.yaml \\"
echo "  --parameters \\"
echo "    ParameterKey=ProjectName,ParameterValue=\"\$PROJECT_NAME\" \\"
echo "    ParameterKey=Environment,ParameterValue=\"\$ENVIRONMENT\" \\"
echo "    ParameterKey=AlertEmail,ParameterValue=\"\$ALERT_EMAIL\" \\"
echo "  --region ap-northeast-1"

echo ""
echo "============================================="

# 7. ä»£æ›¿æ¡ˆï¼šæ—¢å­˜ã®AWSãƒãƒãƒ¼ã‚¸ãƒ‰ãƒãƒªã‚·ãƒ¼ä½¿ç”¨
echo "ğŸ”„ ä»£æ›¿æ¡ˆ - æ—¢å­˜ã®AWSãƒãƒãƒ¼ã‚¸ãƒ‰ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ç”¨:"
echo ""
echo "# ã‚ˆã‚ŠåŒ…æ‹¬çš„ãªæ¨©é™ï¼ˆé–‹ç™ºç’°å¢ƒç”¨ï¼‰"
echo "aws iam attach-user-policy \\"
echo "  --user-name portfolio-deploy-IAM \\"
echo "  --policy-arn arn:aws:iam::aws:policy/CloudWatchFullAccess"
echo ""
echo "aws iam attach-user-policy \\"
echo "  --user-name portfolio-deploy-IAM \\"
echo "  --policy-arn arn:aws:iam::aws:policy/AmazonSSMFullAccess"
echo ""
echo "aws iam attach-user-policy \\"
echo "  --user-name portfolio-deploy-IAM \\"
echo "  --policy-arn arn:aws:iam::aws:policy/AmazonSNSFullAccess"

echo ""
echo "============================================="
echo "âœ… ä¿®æ­£å®Œäº†å¾Œã€ä¸Šè¨˜ã®æ‰‹é †ã«å¾“ã£ã¦å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„"